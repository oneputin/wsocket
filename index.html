<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>web-socket Test</title>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="bower_components/paper-card/paper-card.html">
    <link rel="import" href="bower_components/paper-input/paper-input.html">
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/web-socket/web-socket.html">
    <link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">

    <style is="custom-style">
      paper-card {
        display: block;
        width: 500px;
        margin: 0 auto;
        font-family: Roboto;
      }

      .container {
        display: flex;
        justify-content: space-between;
      }

      paper-input {
        flex-basis: 65%;
      }

      paper-button {
        flex-basis: 25%;
        height: 40px;
        margin-top: 20px;
      }

      div[status] {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 12px;
      }

      div[status=connected] {
        color: green;
      }

      div[status=disconnected] {
        color: red;
      }
    </style>
 
  </head>
  <body unresolved>
    <template is="dom-bind">
      <web-socket id ="ws"
                  url="[[socketUrl]]"
                  auto
                  on-open="_onOpen" 
                  on-close="_onClose"
                  on-message="_onMessage">
      </web-socket>

      <paper-card heading="web-socket demo">

        <div status$="[[status]]" on-tap="toggleConnection">[[status]]</div>

        <div class="card-content">
          <p>The WebSocket at
          <paper-dropdown-menu label="server" on-iron-select="_itemSelected">
            <paper-listbox class="dropdown-content">
              <paper-item value="ws://echo.websocket.org">websocket.org</paper-item>
              <paper-item value="ws://echo.iimaps.de">iimaps.de</paper-item>
              <paper-item value="ws://echo.npp.com">npp.com</paper-item>
              <paper-item value="ws://echo.moneris.org">moneris.org</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          echoes back the (specifically modified) msg.</p>

          <template is="dom-repeat" items="[[messages]]">
            <pre>[[item.author]]: [[item.text]]</pre>
          </template>

          <div class="container">
            <paper-input id="message" label="Message" autofocus></paper-input>
            <paper-button raised on-tap="send">Send</paper-button>
          </div>
        </div>
      </paper-card>

    </template>
    <script>
      var socket;
      var scope  = document.querySelector('template[is=dom-bind]');

      scope.set('messages', []);
      scope.set('status', 'disconnected');

      scope.send = function () {
        // socket = scope.$.ws;
        socket.send(scope.$.message.value);
        scope.push('messages', { author: 'client-log', text: scope.$.message.value});
        scope.$.message.value = '';
        scope.$.message.focus();
      }

      scope.toggleConnection = function () { // console.log("toggling socket-connection");
        var status = this.get('status'); 
        if (status==="connected") {
          socket.close();  //alert('disconnecting socket');
        } else {
          socket.open();  //alert('connecting socket');
        }  
      }

      scope._itemSelected = function (e) {
        var selectedItem = e.target.selectedItem;
        if (selectedItem) {
          var url = selectedItem.getAttribute("value"); console.log("selected value: " + url); 
          scope.set('socketUrl', url);
        }        
      };

      scope._onOpen = function () {
        scope.set('status', 'connected');
      };
      scope._onClose = function () {
        scope.set('status', 'disconnected');
      };
      scope._onMessage = function (event) {
        var echo_msg = event.detail; // 
        scope.push('messages', { author: 'server-echo', text: echo_msg });
      };

      document.addEventListener('WebComponentsReady', function() {
        socket = scope.$.ws;
      })

    </script>
  </body>
</html>
